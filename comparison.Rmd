---
title: "Comparison of savings potentials between measures"
author: "Marlene Kindler"
date: "2025-03-19"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Code for the comparison of savings potentials between measures.

To execute, change:\
- Login data for Nextcloud\
- Adjust download location\
- Adjust upload location\
- Adjust URLs for uploading\

### Load Packages: 
```{r packages, error=FALSE,message=FALSE}
# install.packages("httr")
# install.packages("readxl")
# install.packages("dplyr")
# install.packages("writexl") 
# install.packages("ggplot2")
# install.packages("tidyr")
# install.packages("openxlsx")
# install.packages("flextable")
# install.packages("officer")
# install.packages("tidyverse")
# install.packages("viridis")

library(readxl)
library(httr)
library(dplyr)
library(writexl)
library(ggplot2)
library(tidyr)
library(openxlsx)
library(flextable)
library(officer)
library(tidyverse)
library(viridis)
```

### Parameters
Parameters to be adjusted:
```{r parameters}
# storage location
location_download <- "C:/Users/Klene/Documents/Uni_Bremen/WS24_25/Masterarbeit/R/Daten/"
location_upload <- "C:/Users/Klene/Documents/Uni_Bremen/WS24_25/Masterarbeit/R/Results/"
# Login data for NextCloud
username <- "mkindler@uni-bremen.de" # username
password <- "DLCi3-Qc4iD-dcHzR-fJaXr-cyKHR" # password
# WebDAV-URL to upload
nextcloud_url_2 <- "https://nc.uni-bremen.de/remote.php/dav/files/mkindler%40uni-bremen.de/Masterarbeit/Masterarbeit_II/R/Results/"
```

### Data preparation
Load data:
```{r load_data, warning=FALSE}
# Load results data from Excel file
results1 <- read.csv(paste0(location_upload, "01_data.csv"), check.names = FALSE, stringsAsFactors = FALSE)
results2 <- read.csv(paste0(location_upload, "02_data.csv"), check.names = FALSE, stringsAsFactors = FALSE)
results3 <- read.csv(paste0(location_upload, "03_data.csv"), check.names = FALSE, stringsAsFactors = FALSE)
results4 <- read.csv(paste0(location_upload, "04_data.csv"), check.names = FALSE, stringsAsFactors = FALSE)

# select only data on Climate Change
climateChange1 <- results1[results1$`impact category` == "Climate change",] %>%
  select("SP total", "norm. SP total", "prop. SP total", "relevant") %>%
  rename(SP = "SP total",
         "norm. SP" = "norm. SP total",
         "prop. SP" = "prop. SP total") %>%
  mutate(measure = "01")
climateChange2 <- results2[results2$`impact category` == "Climate change",] %>%
  select("SP FR", "norm. SP FR", "prop. SP FR", "relevant") %>%
  rename(SP = "SP FR", 
         "norm. SP" = "norm. SP FR", 
         "prop. SP" = "prop. SP FR") %>%
  mutate(measure = "02")
climateChange3 <- results3[results3$`impact category` == "Climate change",] %>%
  select("SP RF", "norm. SP RF", "prop. SP RF", "relevant") %>%
  rename(SP = "SP RF", 
         "norm. SP" = "norm. SP RF", 
         "prop. SP" = "prop. SP RF") %>%
  mutate(measure = "03")
climateChange4 <- results4[results4$`impact category` == "Climate change",] %>%
  select("SP MS", "norm. SP MS", "prop. SP MS", "relevant") %>%
  rename(SP = "SP MS", 
         "norm. SP" = "norm. SP MS", 
         "prop. SP" = "prop. SP MS") %>%
  mutate(measure = "04")

climateChange <- bind_rows(climateChange1, climateChange2, climateChange3, climateChange4)
```


### Plot
Plot the climate change savings potential
```{r, warning=FALSE}
climateChange <- climateChange %>%
  arrange(desc(SP))
climateChange$measure <- factor(climateChange$measure, levels = climateChange$measure)

# Plot "relvant"Climate change" impact category
ggplot(climateChange, aes(x = `measure`, y = `SP`, fill = `measure`)) +
  geom_bar(stat = "identity", width = 0.7, show.legend = FALSE) +
  geom_hline(yintercept = 0, color = "black", linetype = "solid") +
  geom_text(
    aes(
      label = round(`SP`, 0), 
      vjust = ifelse(measure == "03", -3.7, -0.5)
    ), 
    size = 7
  ) +
  scale_y_continuous(expand = expansion(mult = c(0.02, 0.04))) +
  labs(
    x = "Measure",
    y = "Savings potential in kg CO2-Eq"
  ) +
  scale_fill_manual(values = c("01" = "lightskyblue4", 
                               "02" = "brown", 
                               "03" = "goldenrod2", 
                               "04" = "turquoise4")) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15),
    axis.title.x = element_text(size = 20), 
    axis.title.y = element_text(size = 20)  
  ) 

# Save plot
ggsave(paste0(location_upload, "Comparison_CO2.png"), width = 10, height =10, dpi = 600)
```
Plot normalized data:
```{r}
climateChange <- climateChange %>%
  mutate(x = "Climate change")

# arrange accending
climateChange <- climateChange %>%
  arrange(abs(`norm. SP`))
climateChange$measure <- factor(climateChange$measure, levels = climateChange$measure)

ggplot(climateChange, aes(x = x, y = `norm. SP`, fill = `measure`)) +
  geom_bar(position = "stack" , stat = "identity", width = 0.4, show.legend = TRUE) +
  geom_text(
    aes(label = formatC(`norm. SP`, format = "e", digits = 2)), 
    position = position_stack(vjust = 0.5), 
    size = 5,                               
    color = "black"                           
  ) +
  labs(
    x = "",
    y = "Share of planetary boudary for climate change") +
  scale_fill_manual(values = c("01" = "lightskyblue4", 
                               "02" = "brown", 
                               "03" = "goldenrod2", 
                               "04" = "turquoise4")) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15),
    axis.title.x = element_text(size = 20), 
    axis.title.y = element_text(size = 20)  
  ) +
  theme(legend.position = "right")

# Save plot
ggsave(paste0(location_upload, "Comparison_norm_CO2.png"), width = 10, height =10, dpi = 600)

```


Plot all absolute impact categories
```{r}
# Data preparation
data1 <- results1 %>%
  mutate(measure = "01") %>%
  rename("SP" = "SP total") %>%
  select("impact category", "unit", "SP", "measure")
data2 <- results2 %>%
  mutate(measure = "02") %>%
  rename("SP" = "SP FR") %>%
  select("impact category", "unit", "SP", "measure")
data3 <- results3 %>%
  mutate(measure = "03") %>%
  rename("SP" = "SP RF") %>%
  select("impact category", "unit", "SP", "measure")
data4 <- results4 %>%
  mutate(measure = "04") %>%
  rename("SP" = "SP MS") %>%
  select("impact category", "unit", "SP", "measure")

data <- data.frame(
  individual = data1$`impact category`,
  unit = data1$unit,
  value1 = data1$`SP`,
  value2 = data2$`SP`,
  value3 = data3$`SP`,
  value4 = data4$`SP`)

data$individual <- recode(data$individual,
  "Energy resources: non-renewable" = "Energy resources n-r",
  "Ionising radiation: human health" = "Ionising radiation: hh",
  "Material resources: metals/minerals" = "Material resources",
  "Particulate matter formation" = "PMF",
  "Photochemical oxidant formation: human health" = "POF: hh"
)
data <- data %>%
  mutate(individual = paste0(individual, " (", unit, ")"))
data <- data %>%
  select(-unit)

data_long <- data

# Transform data into long format
data_long <- data_long %>% 
  gather(key = "measure", value = "value", -individual)


ggplot(data_long, aes(x = individual, y = value, fill = measure)) +
  geom_bar(position = "stack", stat = "identity", width = 0.4, show.legend = TRUE) +
  geom_text(
    aes(label = formatC(value, format = "e", digits = 2)), 
    position = position_stack(vjust = 0.5), 
    size = 3.5,                              
    color = "black"
  ) +
  labs(
    x = "impact category",
    y = "unit"
  ) +
  scale_fill_manual(values = c("value1" = "lightskyblue4", 
                               "value2" = "brown", 
                               "value3" = "goldenrod2", 
                               "value4" = "turquoise4")) +
  theme_minimal() +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_text(size = 12),
    axis.title.x = element_text(size = 18), 
    axis.title.y = element_text(size = 18),
    strip.text = element_text(size = 14, face = "bold") 
  ) +
  facet_wrap(~individual, scales = "free") +
  theme(legend.position = "below")

# Save plot
ggsave(paste0(location_upload, "absolute_all.png"), width = 20, height =20, dpi = 600)

```





Plot all normalized impact categories
```{r}
# Data preparation
data1 <- results1 %>%
  mutate(measure = "01") %>%
  rename("norm. SP" = "norm. SP total") %>%
  select("impact category", "unit", "norm. SP", "measure")
data2 <- results2 %>%
  mutate(measure = "02") %>%
  rename("norm. SP" = "norm. SP FR") %>%
  select("impact category", "unit", "norm. SP", "measure")
data3 <- results3 %>%
  mutate(measure = "03") %>%
  rename("norm. SP" = "norm. SP RF") %>%
  select("impact category", "unit", "norm. SP", "measure")
data4 <- results4 %>%
  mutate(measure = "04") %>%
  rename("norm. SP" = "norm. SP MS") %>%
  select("impact category", "unit", "norm. SP", "measure")

data <- data.frame(
  individual = data1$`impact category`,
  value1 = data1$`norm. SP`,
  value2 = data2$`norm. SP`,
  value3 = data3$`norm. SP`,
  value4 = data4$`norm. SP`)


data_long <- data
# data_long <- data_long %>% filter(individual != "Land use" & individual != "Eutrophication: freshwater")


# data_long$individual <- recode(data_long$individual,
#   "Acidification" = "A",
#   "Climate change" = "CC",
#   "Energy resources: non-renewable" = "nrER",
#   "Eutrophication: freshwater" = "fwE",
#   "Eutrophication: marine" = "mE",
#   "Eutrophication: terrestrial" = "tE",
#   "Ionising radiation: human health" = "IR-hh",
#   "Land use" = "Land use",
#   "Material resources: metals/minerals" = "MR",
#   "Ozone depletion" = "OD",
#   "Particulate matter formation" = "PMF",
#   "Photochemical oxidant formation: human health" = "POF-hh",
#   "Water use" = "Water use"
# )

data_long$individual <- recode(data_long$individual,
    "Photochemical oxidant formation: human health" = "Photochemical oxidant formation: hh")

# Transform data into long format
data_long <- data_long %>% 
  gather(key = "measure", value = "value", -individual)

# # Sortiere measure innerhalb jeder individual-Kategorie nach Wertgröße (größte zuerst)
# data_long <- data_long %>%
#   group_by(individual) %>%
#   arrange(desc(value), .by_group = TRUE)  # Sortiere von groß nach klein
# 
# # Konvertiere measure in einen Faktor mit den neuen Levels (größte zuerst)
# data_long$measure <- factor(data_long$measure, levels = unique(data_long$measure))

# data_long <- data_long %>%
#   arrange(abs(value)) %>%  # Sortiere Werte für jede Kategorie
#   mutate(individual = factor(individual, levels = unique(individual)))

ggplot(data_long, aes(x = individual, y = value, fill = measure)) +
  geom_bar(position = "stack", stat = "identity", width = 0.4, show.legend = TRUE) +
  geom_text(
    aes(label = formatC(value, format = "e", digits = 2)), 
    position = position_stack(vjust = 0.5), 
    size = 3.5,                              
    color = "black"
  ) +
  labs(
    x = "impact category",
    y = "Share of planetary boundary"
  ) +
  scale_fill_manual(values = c("value1" = "lightskyblue4", 
                               "value2" = "brown", 
                               "value3" = "goldenrod2", 
                               "value4" = "turquoise4")) +
  theme_minimal() +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_text(size = 12),
    axis.title.x = element_text(size = 18), 
    axis.title.y = element_text(size = 18),
    strip.text = element_text(size = 14, face = "bold") 
  ) +
  facet_wrap(~individual, scales = "free") +
  theme(legend.position = "below")

# Save plot
ggsave(paste0(location_upload, "norm_all.png"), width = 20, height =20, dpi = 600)

```









### Upload files
```{r, error=FALSE, warning=FALSE}
# List of Excel files to be uploaded
files_to_upload <- list.files(path = location_upload, pattern = "\\.xlsx$", full.names = TRUE)
# Loop over all files and upload
for (file_path in files_to_upload) {
  # Creating the file name 
  file_name <- basename(file_path)
  # Upload file
  response <- PUT(
    url = paste0(nextcloud_url_2, file_name),
    authenticate(username, password),
    body = upload_file(file_path)
  )
  # Check upload status
  if (status_code(response) == 201) {
    print(paste(file_name, "was successfully uploaded."))
  } else if (status_code(response) == 204) {
    print(paste(file_name, "was successfully replaced (no content returned)."))
  } else {
    print(paste("Error uploading", file_name, ". Status-Code:", status_code(response)))
  }
}

# List of PNG files to be uploaded
files_to_upload <- list.files(path = location_upload, pattern = "\\.png$", full.names = TRUE)
# Loop over all files and upload
for (file_path in files_to_upload) {
  # Create the file name
  file_name <- basename(file_path)
  # Upload file
  response <- PUT(
    url = paste0(nextcloud_url_2, file_name),
    authenticate(username, password),
    body = upload_file(file_path)
  )
  # Check upload status
  if (status_code(response) == 201) {
    print(paste(file_name, "was successfully uploaded."))
  } else if (status_code(response) == 204) {
    print(paste(file_name, "was successfully replaced (no content returned)."))
  } else {
    print(paste("Error uploading", file_name, ". Status-Code:", status_code(response)))
  }
}
```

